var jcrop_api;$(function(){var g,b={},h={},m,j,i,c=$("#preview-pane"),l=$("#preview-pane .preview-container"),a=$("#preview-pane .preview-container #crop-preview"),e=l.width(),d=l.height();$(".js-img-list-f").delegate(".js-goal a[data-crop]","click",function(n){n.preventDefault();var o=$(this).data("crop");$("#crop-btn").attr("data-fid",o);$.getJSON(UPLOADDO_URL+"get_ajax/"+o).done(function(r){g=UPLOAD_URL+r.url;var q=g+"?n="+Math.random()*100;console.log("fid : "+o);console.log("img : "+q);var p="<img id='crop-target' src='"+q+"' data-id='"+o+"' alt='' style='max-width:100%;max-height:99%;margin:auto;'>";$("#crop-modal .modal-body").html(p);$("#crop-target").attr("src",q);$("#crop-preview").attr("src",q);$("#crop-modal").css({width:$(window).width()-100,height:$(window).height()-100,top:"50px",left:"25%"});$("#crop-modal .modal-body").css({"max-height":"none",height:"90%"});$("#crop-modal").modal()})});$("#crop-modal").on("hide",function(n){m.destroy()});$("#crop-modal").on("shown",function(n){console.log($("#crop-modal .modal-body").width());console.log($("#crop-target").width());f();console.log("剪裁初始化")});function f(){$("#crop-target").Jcrop({onSelect:k,onChange:k,onRelease:function(){console.log("释放")},aspectRatio:9/6,minSize:[100,100],bgColor:"#fff",bgOpacity:0.5},function(){m=this;bounds=m.getBounds();j=bounds[0];i=bounds[1];c.appendTo(m.ui.holder);imgReady($("#crop-target").attr("src"),function(){b.w=this.width;b.h=this.height})})}function k(p){h=p;if(parseInt(p.w)>0){var o=e/p.w;var n=d/p.h;a.css({width:Math.round(o*j)+"px",height:Math.round(n*i)+"px",marginLeft:"-"+Math.round(o*p.x)+"px",marginTop:"-"+Math.round(n*p.y)+"px"})}}$("#crop-btn").on("click",function(t){t.preventDefault;if($.isNumeric(h.x)){console.log("crop data ok!");m.release();var v={},o=b,n={},p={},u={};v=h;n.w=$("#crop-target").width();n.h=$("#crop-target").height();p.x=o.w/n.w;p.y=o.h/n.h;u.x=v.x*p.x;u.y=v.y*p.y;u.w=v.w*p.x;u.h=v.h*p.y;u.fid=$(this).attr("data-fid")-0;var q=$("a[data-crop="+u.fid+"]").parents(".js-goal").find(".fancybox-img");console.log("c is");console.log(v);console.log("s is");console.log(o);console.log("r is");console.log(p);console.log("i is");console.log(n);console.log("d is");console.log(u);$.ajax({url:UPLOADDO_URL+"gd_ajax",type:"GET",dataType:"json",data:u}).done(function(r){console.log("success");if(r.status==1){$.pnotify({title:"裁剪",text:r.msg,type:"success",animation:"fade"});tmp_url=g+"?n="+Math.random()*100;m.destroy();$("#crop-target").remove();$("#crop-bench").html('<img src="'+tmp_url+'" id="crop" >');$("#crop-preview").attr("src",tmp_url);$("#crop-modal").modal("hide");$(q).attr("href",tmp_url)}else{bootbox.alert("<span class='text-error'>"+r.msg+"</span>")}}).fail(function(s,x,w){var r=s.responseJSON;$.pnotify({title:"错误提示！",text:r.msg,type:"error",animation:"fade"});$("#"+domf).after(ui.alert("访问数据列表错误 ：<br />"+r))}).always(function(){console.log("complete")})}else{bootbox.alert("你还没有任何的裁剪。")}})});